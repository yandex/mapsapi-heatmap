ymaps.modules.define("Heatmap",["util.math.areEqual","option.Manager","Monitor","Layer","heatmap.component.TileUrlsGenerator"],function(a,b,c,d,e,f){function g(a){return"Feature"==a.type}function h(a){var b=1;return a.properties&&a.properties.weight&&(b=a.properties.weight),{coordinates:a.geometry.coordinates,weight:b}}function i(a){return"FeatureCollection"==a.type}function j(a){return"[object Array]"==Object.prototype.toString.call(a)&&"number"==typeof a[0]&&"number"==typeof a[1]}function k(a){return{coordinates:a,weight:1}}function l(a){return!(!a.type||!a.coordinates)}function m(a){return!(!a.geometry||!a.getOverlay)}function n(a){return{coordinates:a.geometry.getCoordinates(),weight:a.properties.get("weight")||1}}function o(a){return!!a.getIterator}var p=function(a,b){this._unprocessedPoints=[],a&&this.setData(a),this.options=new c(b)};p.prototype.getData=function(){return this._data||null},p.prototype.setData=function(a){var b=this._convertDataToPointsArray(a);return this._data=a,this._tileUrlsGenerator?(this._tileUrlsGenerator.setPoints(b),this._refresh()):this._unprocessedPoints=b,this},p.prototype.getMap=function(){return this._map},p.prototype.setMap=function(a){return this._map!=a&&(this._layer&&(this._map.layers.remove(this._layer),this._destroyLayer()),this._map=a,a&&(this._setupLayer(),this._map.layers.add(this._layer))),this},p.prototype.destroy=function(){this._data=null,this.setMap(null)},p.prototype._convertDataToPointsArray=function(a){var b=[];if("string"==typeof object&&(a=JSON.parse(a)),g(a)&&"Point"==a.geometry.type)b.push(h(a));else if(i(a))for(var c=0,d=a.features.length;d>c;c++)b=b.concat(this._convertDataToPointsArray(a.features[c]));else if(j(a))b.push(k(a));else for(var e,f=[].concat(a),c=0,d=f.length;d>c;c++)if(e=f[c],j(e))b.push(k(e));else if(l(e)&&"Point"==e.type)b.push(k(e.coordinates));else if(m(e)&&"Point"==e.geometry.getType())b.push(n(e));else if(o(e))for(var p,q=e.getIterator();(p=q.getNext())!=q.STOP_ITERATION;)b=b.concat(this._convertDataToPointsArray(p));return b},p.prototype._refresh=function(){return this._layer&&this._layer.update(),this},p.prototype._setupLayer=function(){this._setupTileUrlsGenerator();var a=this._tileUrlsGenerator.getTileUrl.bind(this._tileUrlsGenerator);return this._layer=new e(a,{tileTransparent:!0}),this._setupOptionMonitor(),this._layer},p.prototype._destroyLayer=function(){this._destroyTileUrlsGenerator(),this._destroyOptionMonitor(),this._layer=null},p.prototype._setupTileUrlsGenerator=function(){return this._tileUrlsGenerator=new f(this._map.options.get("projection"),this._unprocessedPoints),this._unprocessedPoints=null,this._tileUrlsGenerator.options.setParent(this.options),this._tileUrlsGenerator},p.prototype._destroyTileUrlsGenerator=function(){this._unprocessedPoints=this._tileUrlsGenerator.getPoints(),this._tileUrlsGenerator.destroy(),this._tileUrlsGenerator=null},p.prototype._setupOptionMonitor=function(){return this._optionMonitor=new d(this.options),this._optionMonitor.add(["radius","dissipating","opacity","intensityOfMidpoint","gradient"],this._refresh,this)},p.prototype._destroyOptionMonitor=function(){this._optionMonitor.removeAll(),this._optionMonitor={}},a(p)}),ymaps.modules.define("heatmap.component.Canvas",["option.Manager","Monitor"],function(a,b,c){var d={radius:10,radiusFactor:1,opacity:.6,intensityOfMidpoint:.2,medianaOfWeights:1,gradient:{.1:"rgba(128, 255, 0, 1)",.2:"rgba(255, 255, 0, 1)",.7:"rgba(234, 72, 58, 1)",1:"rgba(162, 36, 25, 1)"}},e=function(a){this._canvas=document.createElement("canvas"),this._canvas.width=a[0],this._canvas.height=a[1],this._context=this._canvas.getContext("2d"),this.options=new b({}),this._setupDrawTools(),this._setupOptionMonitor()};e.prototype.getBrushRadius=function(){return this.options.get("radius",d.radius)*this.options.get("radiusFactor",d.radiusFactor)},e.prototype.generateDataURLHeatmap=function(a){return this._drawHeatmap(a||[]),this._canvas.toDataURL()},e.prototype.destroy=function(){this._destroyOptionMonitor(),this._destroyDrawTools()},e.prototype._setupOptionMonitor=function(){return this._optionMonitor=new c(this.options),this._optionMonitor.add(["radius","radiusFactor","gradient"],this._setupDrawTools,this)},e.prototype._destroyOptionMonitor=function(){this._optionMonitor.removeAll(),this._optionMonitor={}},e.prototype._setupDrawTools=function(){return this._brush=this._createBrush(),this._gradient=this._createGradient(),this},e.prototype._destroyDrawTools=function(){this._brush=null,this._gradient=null},e.prototype._createBrush=function(){var a=document.createElement("canvas"),b=a.getContext("2d"),c=this.getBrushRadius(),d=b.createRadialGradient(c,c,0,c,c,c);return d.addColorStop(0,"rgba(0,0,0,1)"),d.addColorStop(1,"rgba(0,0,0,0)"),b.fillStyle=d,b.fillRect(0,0,2*c,2*c),a},e.prototype._createGradient=function(){var a=document.createElement("canvas"),b=a.getContext("2d"),c=b.createLinearGradient(0,0,0,256);a.width=1,a.height=256;var e=this.options.get("gradient",d.gradient);for(var f in e)e.hasOwnProperty(f)&&c.addColorStop(f,e[f]);return b.fillStyle=c,b.fillRect(0,0,1,256),b.getImageData(0,0,1,256).data},e.prototype._drawHeatmap=function(a){var b=this._context,c=this.getBrushRadius(),e=this.options.get("intensityOfMidpoint",d.intensityOfMidpoint),f=this.options.get("medianaOfWeights",d.medianaOfWeights),g=e/f;b.clearRect(0,0,this._canvas.width,this._canvas.height);for(var h=0,i=a.length;i>h;h++)b.globalAlpha=Math.min(a[h].weight*g,1),b.drawImage(this._brush,a[h].coordinates[0]-c,a[h].coordinates[1]-c);var j=b.getImageData(0,0,this._canvas.width,this._canvas.height);return this._colorize(j.data),b.putImageData(j,0,0),this},e.prototype._colorize=function(a){for(var b,c=255*this.options.get("opacity",d.opacity),e=3,f=a.length;f>e;e+=4)a[e]&&(b=4*a[e],a[e-3]=this._gradient[b],a[e-2]=this._gradient[b+1],a[e-1]=this._gradient[b+2],a[e]=c)},a(e)}),ymaps.modules.define("heatmap.component.TileUrlsGenerator",["option.Manager","heatmap.component.Canvas"],function(a,b,c){function d(a){var b=a.sort(e),c=b.length/2;return c!==Math.floor(c)?b[Math.floor(c)]:(b[c-1]+b[c])/2}function e(a,b){return a-b}var f=[256,256],g=function(a,d){this._projection=a,this._canvas=new c(f),this.options=new b({}),this._canvas.options.setParent(this.options),this.setPoints(d||[])};g.prototype.setPoints=function(a){this._points=[];for(var b=[],c=0,e=a.length;e>c;c++)this._points.push({coordinates:this._projection.toGlobalPixels(a[c].coordinates,0),weight:a[c].weight}),b.push(a[c].weight);return this._canvas.options.set("medianaOfWeights",d(b)),this},g.prototype.getPoints=function(){for(var a=[],b=0,c=this._points.length;c>b;b++)a.push({coordinates:this._projection.fromGlobalPixels(this._points[b].coordinates,0),weight:this._points[b].weight});return a},g.prototype.getTileUrl=function(a,b){var c=this._canvas.options.get("radiusFactor");this.options.get("dissipating")?c!=b&&this._canvas.options.set("radiusFactor",b/10):c&&this._canvas.options.unset("radiusFactor");for(var d,e=Math.pow(2,b),g=[[a[0]*f[0]/e,a[1]*f[1]/e],[(a[0]+1)*f[0]/e,(a[1]+1)*f[1]/e]],h=this._canvas.getBrushRadius(),i=[],j=0,k=this._points.length;k>j;j++)d=this._points[j].coordinates,this._contains(g,d,h)&&i.push({coordinates:[(d[0]-g[0][0])*e,(d[1]-g[0][1])*e],weight:this._points[j].weight});return this._canvas.generateDataURLHeatmap(i)},g.prototype.destroy=function(){this._canvas.destroy(),this._canvas=null,this._projection=null},g.prototype._contains=function(a,b,c){return b[0]>=a[0][0]-c&&b[0]<=a[1][0]+c&&b[1]>=a[0][1]-c&&b[1]<=a[1][1]+c},a(g)});